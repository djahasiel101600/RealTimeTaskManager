user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
	worker_connections  1024;
}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	# Local development: point upstreams at localhost services (8000 for Django, 5173 for Vite dev server)

	# Max upload size (25MB for attachments)
	client_max_body_size 25M;

	sendfile        on;
	keepalive_timeout  65;

	# Gzip (optional)
	gzip on;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# Upstream for Django backend
	upstream backend_app {
		server 127.0.0.1:8000;
	}

	# Upstream for frontend
	upstream frontend_app {
		server 127.0.0.1:5173;
	}

	server {
		listen       80 default_server;
		listen       [::]:80 default_server;
		server_name  _;

		# Frontend SPA: proxy to frontend dev server or built assets
		location / {
			proxy_pass http://frontend_app;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Static and media files served from local static directories
		location /static/ {
			alias /static/;
			access_log off;
			expires 30d;
		}

		location /media/ {
			alias /media/;
			access_log off;
			expires 30d;
		}

		# API proxy to Django backend
		location /api/ {
			proxy_pass http://backend_app;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_redirect off;
		}

		# WebSocket proxy (common path /ws/ or /ws)
		location /ws/ {
			proxy_pass http://backend_app;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			# Forward Sec-WebSocket-Protocol so subprotocol tokens make it to the backend
			proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_read_timeout 86400;
		}

		# Health check endpoint (used for local or deployment health checks)
		location /api/health/ {
			proxy_pass http://backend_app/api/health/;
			proxy_set_header Host $host;
		}

		# Optional: custom error pages
		error_page 502 503 504 /50x.html;
		location = /50x.html {
			root /usr/share/nginx/html;
		}
	}

	# Uncomment and configure the SSL server block if you provide certs under ./nginx/ssl
	# server {
	#     listen 443 ssl;
	#     server_name your.domain.com;
	#     ssl_certificate /etc/nginx/ssl/fullchain.pem;
	#     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
	#     include /etc/nginx/snippets/ssl-params.conf;
	#
	#     root /usr/share/nginx/html;
	#     index index.html;
	#     location / {
	#         try_files $uri $uri/ /index.html;
	#     }
	#
	#     location /api/ {
	#         proxy_pass http://backend_app;
	#     }
	# }

}

