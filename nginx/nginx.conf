user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
	worker_connections  1024;
}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	sendfile        on;
	keepalive_timeout  65;

	# Gzip (optional)
	gzip on;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# Upstream for Django backend
	upstream backend_app {
		server backend:8000;
	}

	server {
		listen       80 default_server;
		listen       [::]:80 default_server;
		server_name  _;

		# Serve the built frontend
		root /usr/share/nginx/html;
		index index.html;

		# Frontend SPA: fallback to index.html for client-side routing
		location / {
			try_files $uri $uri/ /index.html;
		}

		# Static and media files mounted from volumes
		location /static/ {
			alias /static/;
			access_log off;
			expires 30d;
		}

		location /media/ {
			alias /media/;
			access_log off;
			expires 30d;
		}

		# API proxy to Django backend
		location /api/ {
			proxy_pass http://backend_app;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_redirect off;
		}

		# WebSocket proxy (common path /ws/ or /ws)
		location /ws/ {
			proxy_pass http://backend_app;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_read_timeout 86400;
		}

		# Health check endpoint (matches docker-compose healthcheck)
		location /api/health/ {
			proxy_pass http://backend_app/api/health/;
			proxy_set_header Host $host;
		}

		# Optional: custom error pages
		error_page 502 503 504 /50x.html;
		location = /50x.html {
			root /usr/share/nginx/html;
		}
	}

	# Uncomment and configure the SSL server block if you provide certs under ./nginx/ssl
	# server {
	#     listen 443 ssl;
	#     server_name your.domain.com;
	#     ssl_certificate /etc/nginx/ssl/fullchain.pem;
	#     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
	#     include /etc/nginx/snippets/ssl-params.conf;
	#
	#     root /usr/share/nginx/html;
	#     index index.html;
	#     location / {
	#         try_files $uri $uri/ /index.html;
	#     }
	#
	#     location /api/ {
	#         proxy_pass http://backend_app;
	#     }
	# }

}

